import{r,b as ae,a as re,j as e,L as ne}from"./index-Coi2vgDx.js";import{c as E,a as F,B as z,S as ie,I as le,X as ce,k as v,b as R,M as de,m as K,C as oe,d as X}from"./productParams-DSKcz1WG.js";import{u as me}from"./useProducts-DxCa8dnL.js";import{C as Z,g as xe}from"./chainConstants-L7boZneU.js";import{L as J,A as ue,C as he}from"./loader-2-P5zHDR_0.js";import{N as W}from"./navigation-Go8l6rJM.js";const pe=E("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]),fe=E("Award",[["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}],["path",{d:"M15.477 12.89 17 22l-5-3-5 3 1.523-9.11",key:"em7aur"}]]),ge=E("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]),I=E("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]),je=E("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]),Ne="http://localhost:8000",be=()=>{const[a,n]=r.useState(null),[p,m]=r.useState(!1),[x,b]=r.useState(null),f=r.useRef(null),o=r.useCallback(async(u,h,g,y)=>{var _;(_=f.current)==null||_.abort();const w=new AbortController;f.current=w,m(!0),b(null);try{const{data:c}=await F.post(`${Ne}/trolley/compare`,{items:u.map(k=>({product_id:k.product_id,quantity:k.quantity})),lat:h,lon:g,radius_km:y},{signal:w.signal});n(c)}catch(c){if(F.isCancel(c))return;b("Failed to compare trolley prices"),n(null)}finally{m(!1)}},[]);return r.useEffect(()=>()=>{var u;(u=f.current)==null||u.abort()},[]),{comparison:a,loading:p,error:x,compare:o}},ve="http://localhost:8000",ye=()=>{const[a,n]=r.useState(null),[p,m]=r.useState(!1),x=r.useRef(null),b=r.useCallback(async({store_id:f,product_ids:o})=>{var h;if(!o.length){n(null);return}(h=x.current)==null||h.abort();const u=new AbortController;x.current=u,m(!0);try{const{data:g}=await F.post(`${ve}/trolley/suggestions`,{store_id:f,items:o.map(y=>({product_id:y,quantity:1}))},{signal:u.signal});n(g)}catch(g){if(F.isCancel(g))return;n(null)}finally{m(!1)}},[]);return r.useEffect(()=>()=>{var f;(f=x.current)==null||f.abort()},[]),{suggestions:a,loading:p,fetchSuggestions:b}},Ae=()=>{const{items:a,itemCount:n,addItem:p,removeItem:m,updateQuantity:x,clearTrolley:b,isInTrolley:f}=ae(),{location:o,radiusKm:u,isLocationSet:h,openLocationModal:g,requestAutoLocation:y,loading:w,error:_}=re(),{comparison:c,loading:k,error:O,compare:Q}=be(),{suggestions:M,loading:Y,fetchSuggestions:G}=ye(),{products:A,loading:ee,fetchProducts:H}=me(),[S,U]=r.useState(null),[j,q]=r.useState(""),[se,C]=r.useState(!1),P=r.useRef(null),T=r.useRef();r.useEffect(()=>{if(!(!j.trim()||!o))return clearTimeout(T.current),T.current=window.setTimeout(()=>{H({query:j.trim(),lat:o.lat,lon:o.lon,radius_km:u,unique_products:!0,limit:8})},300),()=>clearTimeout(T.current)},[j,o,u,H]),r.useEffect(()=>{const s=d=>{P.current&&!P.current.contains(d.target)&&C(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]),r.useEffect(()=>{a.length>0&&o&&h&&Q(a,o.lat,o.lon,u)},[a,o,u,h,Q]),r.useEffect(()=>{c!=null&&c.stores.length&&!S&&U(c.stores[0].store_id)},[c,S]);const l=(c==null?void 0:c.stores.find(s=>s.store_id===S))??null;return r.useEffect(()=>{if(!l||l.is_complete)return;const s=l.items.filter(d=>!d.available).map(d=>d.source_product_id);s.length>0&&G({store_id:l.store_id,product_ids:s})},[S,l==null?void 0:l.is_complete,G]),e.jsxs("div",{className:"min-h-screen bg-secondary",children:[e.jsx("div",{className:"bg-primary text-white px-4 py-3",children:e.jsxs("div",{className:"max-w-6xl mx-auto flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ne,{to:"/",className:"text-lg font-semibold",children:"GROCIFY"}),e.jsx("span",{className:"text-white/60",children:"/"}),e.jsx("h1",{className:"text-sm font-medium",children:"Your Trolley"})]}),n>0&&e.jsx(z,{variant:"ghost",size:"sm",className:"text-white/70 hover:bg-white/10 hover:text-white",onClick:b,children:"Clear All"})]})}),e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-6xl mx-auto px-4 py-3",children:e.jsxs("div",{ref:P,className:"relative",children:[e.jsx(ie,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(le,{placeholder:"Search products to add...",value:j,onChange:s=>{q(s.target.value),C(!0)},onFocus:()=>j.trim()&&C(!0),className:"pl-10 pr-8 h-9 text-sm"}),j&&e.jsx("button",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground",onClick:()=>{q(""),C(!1)},children:e.jsx(ce,{className:"h-4 w-4"})}),se&&j.trim()&&e.jsx("div",{className:"absolute z-50 top-full left-0 right-0 mt-1 bg-white border rounded-lg shadow-lg max-h-80 overflow-y-auto",children:ee?e.jsxs("div",{className:"p-4 flex items-center justify-center gap-2 text-sm text-muted-foreground",children:[e.jsx(J,{className:"h-4 w-4 animate-spin"}),"Searching..."]}):A!=null&&A.items.length?A.items.map(s=>e.jsx(_e,{product:s,inTrolley:f(s.id),onAdd:()=>{p(s),q(""),C(!1)}},s.id)):e.jsx("div",{className:"p-4 text-sm text-muted-foreground text-center",children:"No products found"})})]})})}),e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-6",children:[n===0&&e.jsx("div",{className:"flex items-center justify-center py-24",children:e.jsxs(v,{className:"p-8 text-center max-w-md border bg-card",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 rounded-full bg-secondary mb-4",children:e.jsx(R,{className:"h-8 w-8 text-muted-foreground"})}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Your trolley is empty"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Search for products above or browse the Explore page to add items."})]})}),n>0&&!h&&e.jsx("div",{className:"flex items-center justify-center py-24",children:e.jsxs(v,{className:"p-8 text-center max-w-md border bg-card",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-12 h-12 rounded-lg bg-secondary mb-4",children:e.jsx(W,{className:"h-6 w-6 text-primary"})}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Location Required"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-6",children:"Enable location to compare trolley prices at stores near you."}),_&&e.jsx("div",{className:"mb-4 p-3 bg-destructive/10 border border-destructive/20 rounded-lg",children:e.jsx("p",{className:"text-sm text-destructive",children:_})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{onClick:y,disabled:w,className:"w-full",children:w?"Getting location...":e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"Use My Location"]})}),e.jsxs(z,{onClick:g,variant:"outline",className:"w-full",children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Set Manually"]})]})]})}),n>0&&h&&k&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(K,{className:"h-24 w-full rounded-lg"},s))}),e.jsx(K,{className:"h-80 w-full rounded-lg"})]}),n>0&&h&&O&&e.jsx("div",{className:"bg-destructive/10 border border-destructive/20 rounded-lg p-4 mb-4",children:e.jsxs("p",{className:"text-sm text-destructive flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4"}),O]})}),n>0&&h&&!k&&c&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-sm font-semibold text-muted-foreground mb-3 uppercase tracking-wide",children:"Store Rankings"}),c.stores.length===0?e.jsx(v,{className:"p-6 text-center bg-card",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"No nearby stores found"})}):e.jsx("div",{className:"space-y-2",children:c.stores.map((s,d)=>e.jsx(we,{store:s,rank:d+1,isSelected:s.store_id===S,isBestPrice:d===0&&s.is_complete,onClick:()=>U(s.store_id)},s.store_id))})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-sm font-semibold text-muted-foreground mb-3 uppercase tracking-wide",children:"Item Breakdown"}),l?e.jsxs(v,{className:"bg-card overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b bg-secondary/50",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{chain:l.chain,className:"h-5 w-5"}),e.jsx("span",{className:"font-medium text-sm",children:l.store_name})]})}),e.jsx("div",{children:(()=>{const s={};return l.items.forEach(d=>{const L=c.items.find($=>$.product_id===d.source_product_id),t=(L==null?void 0:L.department)||"Other";s[t]||(s[t]=[]),s[t].push(d)}),Object.entries(s).map(([d,L])=>e.jsxs("div",{children:[e.jsx("div",{className:"px-3 py-1.5 bg-secondary/70 border-y",children:e.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:d})}),e.jsx("div",{className:"divide-y",children:L.map((t,$)=>{var V,D;const N=c.items.find(i=>i.product_id===t.source_product_id),B=t.available||(V=M==null?void 0:M.items.find(i=>i.source_product_id===t.source_product_id))==null?void 0:V.suggestions;return e.jsxs(r.Fragment,{children:[e.jsxs("div",{className:`p-3 flex items-center gap-3 ${t.available?"":"opacity-50"}`,children:[N!=null&&N.image_url?e.jsx("img",{src:N.image_url,alt:t.source_product_name,className:"w-10 h-10 object-contain rounded flex-shrink-0"}):e.jsx("div",{className:"w-10 h-10 bg-muted rounded flex items-center justify-center flex-shrink-0",children:e.jsx(R,{className:"h-4 w-4 text-muted-foreground/30"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:t.matched_product_name??t.source_product_name}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{className:"h-5 w-5 rounded flex items-center justify-center hover:bg-muted text-muted-foreground",onClick:()=>x(t.source_product_id,t.quantity-1),disabled:t.quantity<=1,children:e.jsx(ge,{className:"h-3 w-3"})}),e.jsx("span",{className:"text-xs font-medium w-4 text-center",children:t.quantity}),e.jsx("button",{className:"h-5 w-5 rounded flex items-center justify-center hover:bg-muted text-muted-foreground",onClick:()=>x(t.source_product_id,t.quantity+1),disabled:t.quantity>=99,children:e.jsx(I,{className:"h-3 w-3"})})]}),!t.available&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"— Unavailable"}),e.jsx("button",{className:"h-5 w-5 rounded flex items-center justify-center hover:bg-destructive/10 text-muted-foreground hover:text-destructive ml-1",onClick:()=>m(t.source_product_id),children:e.jsx(je,{className:"h-3 w-3"})})]})]}),e.jsx("div",{className:"text-right flex-shrink-0",children:t.available&&t.price!=null?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm font-semibold",children:["$",(D=t.line_total)==null?void 0:D.toFixed(2)]}),t.quantity>1&&e.jsxs("p",{className:"text-[10px] text-muted-foreground",children:["$",t.price.toFixed(2)," ea"]})]}):e.jsx("p",{className:"text-xs text-muted-foreground",children:"—"})})]}),!t.available&&(Y||B&&B.length>0)&&e.jsx("div",{className:"bg-amber-50/50 border-l-2 border-amber-300",children:Y?e.jsxs("div",{className:"px-4 py-2 flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(J,{className:"h-3 w-3 animate-spin"}),"Finding alternatives..."]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-4 py-1.5 text-[10px] font-semibold text-amber-700 uppercase tracking-wide",children:"Suggestions"}),B.map(i=>{const te=i.promo_price_nzd??i.price_nzd;return e.jsxs("div",{className:"px-4 py-2 flex items-center gap-3 hover:bg-amber-50/80 transition-colors",children:[i.image_url?e.jsx("img",{src:i.image_url,alt:i.name,className:"w-8 h-8 object-contain rounded flex-shrink-0"}):e.jsx("div",{className:"w-8 h-8 bg-muted rounded flex items-center justify-center flex-shrink-0",children:e.jsx(R,{className:"h-3 w-3 text-muted-foreground/30"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-medium truncate",children:i.name}),i.size&&e.jsx("p",{className:"text-[10px] text-muted-foreground",children:i.size})]}),e.jsxs("span",{className:"text-xs font-semibold text-primary flex-shrink-0",children:["$",te.toFixed(2)]}),e.jsxs(z,{variant:"outline",size:"sm",className:"h-6 text-[10px] px-2 flex-shrink-0",onClick:()=>{m(t.source_product_id),p({id:i.product_id,name:i.name,brand:i.brand,size:i.size,chain:l.chain,image_url:i.image_url,department:N==null?void 0:N.department,price:{store_id:l.store_id,store_name:l.store_name,chain:l.chain,price_nzd:i.price_nzd,promo_price_nzd:i.promo_price_nzd},last_updated:new Date().toISOString()})},children:[e.jsx(pe,{className:"h-3 w-3 mr-1"}),"Swap"]})]},i.product_id)})]})})]},$)})})]},d))})()}),e.jsxs("div",{className:"p-4 border-t bg-secondary/50 flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:[l.items_available,"/",l.items_total," items available"]}),e.jsxs("span",{className:"text-lg font-bold text-primary",children:["$",l.estimated_total.toFixed(2)]})]})]}):e.jsx(v,{className:"p-6 text-center bg-card",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Select a store to see the breakdown"})})]})]})]})]})},we=({store:a,rank:n,isSelected:p,isBestPrice:m,onClick:x})=>e.jsx(v,{className:`p-3 cursor-pointer transition-all hover:shadow-sm ${p?"ring-2 ring-primary bg-primary/5":"bg-card"}`,onClick:x,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-6 text-center",children:e.jsxs("span",{className:"text-xs font-bold text-muted-foreground",children:["#",n]})}),e.jsx(Z,{chain:a.chain,className:"h-6 w-6 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:a.store_name}),m&&e.jsxs(X,{className:"bg-primary text-white text-[10px] px-1.5 py-0",children:[e.jsx(fe,{className:"h-3 w-3 mr-0.5"}),"Best Price"]})]}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground mt-0.5",children:[e.jsx("span",{children:xe(a.chain)}),e.jsxs("span",{children:[a.distance_km," km"]}),e.jsxs(X,{variant:a.is_complete?"default":"secondary",className:"text-[10px] px-1.5 py-0",children:[a.items_available,"/",a.items_total," items"]})]})]}),e.jsx("div",{className:"text-right flex-shrink-0",children:e.jsxs("p",{className:"text-lg font-bold text-primary",children:["$",a.estimated_total.toFixed(2)]})}),e.jsx(he,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]})}),_e=({product:a,inTrolley:n,onAdd:p})=>{const m=a.price.promo_price_nzd??a.price.price_nzd;return e.jsxs("div",{className:"flex items-center gap-3 px-3 py-2 hover:bg-secondary/50 cursor-pointer transition-colors",children:[a.image_url?e.jsx("img",{src:a.image_url,alt:a.name,className:"w-9 h-9 object-contain rounded flex-shrink-0"}):e.jsx("div",{className:"w-9 h-9 bg-muted rounded flex items-center justify-center flex-shrink-0",children:e.jsx(R,{className:"h-4 w-4 text-muted-foreground/30"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:a.name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[a.size&&e.jsx("span",{children:a.size}),e.jsx("span",{children:a.price.store_name})]})]}),e.jsxs("span",{className:"text-sm font-semibold text-primary flex-shrink-0",children:["$",m.toFixed(2)]}),e.jsx(z,{variant:n?"secondary":"default",size:"sm",className:"flex-shrink-0 h-7 text-xs px-2",onClick:x=>{x.stopPropagation(),n||p()},disabled:n,children:n?e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"h-3 w-3 mr-1"}),"Added"]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"h-3 w-3 mr-1"}),"Add"]})})]})};export{Ae as Trolley,Ae as default};
